#!/usr/bin/env node
const os = require("os");
const fs = require("fs/promises");
const path = require("path");
const { spawnSync } = require("child_process");

async function main() {
  const tmp = await fs.mkdtemp(path.join(os.tmpdir(), "goya-dict-"));
  spawnSync(
    "cargo",
    [
      "run",
      "-p",
      "goya-cli",
      "--release",
      "--",
      "--dicdir",
      tmp,
      "compile",
      process.argv[2],
    ],
    { stdio: "inherit" }
  );

  const base = path.join(__dirname, "..");
  const generatedDir = path.join(base, "wasm-core", "__generated__");
  await fs.rmdir(generatedDir, { recursive: true });
  await fs.rename(tmp, generatedDir);
}

main();
